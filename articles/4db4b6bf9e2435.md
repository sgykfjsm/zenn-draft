---
title: TiDBã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ãŸã„
emoji: ğŸ‘“
type: tech
topics:
  - database
  - tidb
published: true
---
# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦
ã“ã®è¨˜äº‹ã§ã¯ã€TiDBãŒå®Ÿè¡Œã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

MySQLã«ã¯DBã‚µãƒ¼ãƒãƒ¼ãŒå®Ÿè¡Œã—ãŸã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã€ä¸€èˆ¬ã«general logã¨ã„ã†åå‰ã§å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚
- https://dev.mysql.com/doc/refman/8.0/en/query-log.html

MySQLäº’æ›ã‚’è¬³ã†TiDBã«ã‚‚ã“ã®general logæ©Ÿèƒ½ã¯ç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€TiDB Self-Managed (ã„ã‚ã‚†ã‚‹ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç‰ˆ)ã‚„playgroundã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
- https://docs.pingcap.com/tidb/stable/system-variables#tidb_general_log

general logã¯ãƒ‡ãƒãƒƒã‚°ç›®çš„ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒå¤šãã€ä¾‹ãˆã°ã€ORMãªã©ãŒç”Ÿæˆã—ãŸã‚¯ã‚¨ãƒªãŒå®Ÿéš›ã«ã©ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªã¨ã—ã¦MySQLã«å±Šã„ã¦ã„ã‚‹ã®ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ãªã©ã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«å¤§å¤‰ä¾¿åˆ©ãªgeneral logã§ã™ãŒã€TiDBã§ã¯ä»¥å‰ã‹ã‚‰åˆ©ç”¨å¯èƒ½ã§ã¯ã‚ã£ãŸã‚‚ã®ã®ã€v8.0ä»¥å‰ã¯tidb.logã«å‡ºåŠ›ã•ã‚Œã¦ä»–ã®ãƒ­ã‚°ã¨æ··ã–ã£ã¦ã—ã¾ã†ãŸã‚ã€ã‚„ã‚„ä½¿ã„å‹æ‰‹ãŒã‚ˆãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€v8.0ã‹ã‚‰ã¯æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ä¸€æ–¹ã€TiDB Cloudã§ã¯ã¾ã general logã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€general logã‚’ä½¿ã£ãŸãƒ‡ãƒãƒƒã‚°ã¨ã„ã†ã‚‚ã®ãŒã‚„ã‚Šã¥ã‚‰ã„ã§ã™ã€‚

:::message
TiDB Cloudã§ã¯å¯¾è±¡ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã§å®Ÿè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒªã‚’çµ±è¨ˆçš„ã«å‚ç…§ã§ãã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã®ã§ã€å®Ÿè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒªã®å±¥æ­´ãŒå…¨ãè¦‹ã‚Œãªã„ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“
- https://docs.pingcap.com/tidbcloud/tune-performance#statement-analysis
:::

ã“ã®è¨˜äº‹ã§ã¯TiDB Self-Managedã‚„Playgroundã§general logã‚’æœ‰åŠ¹ã«ã™ã‚‹æ–¹æ³•ã€ãã—ã¦general logã‚’æœ‰åŠ¹ã«ã§ããªã„å ´åˆã«ã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚ãªãŠã€å¾Œè€…ã§ã¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’ç‹¬è‡ªã«å®Ÿè£…ã—ã¾ã™ã€‚ç‹¬è‡ªã«å®Ÿè£…ã™ã‚‹ã¨ã¯ã„ãˆã€æ—¢å­˜ã®MySQLãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã™ã‚‹ç°¡æ˜“ãªã‚‚ã®ãªã®ã§å®Ÿè£…ã¯é›£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãœã²æœ€å¾Œã¾ã§ã”è¦§ãã ã•ã„ã€‚

# TiDBã§general logã‚’è¨­å®šã™ã‚‹
TiDBã§general logã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€ã©ã®ã‚ˆã†ã«ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã‚‹ã®ã‹ã‚’ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚‚ã—ã“ã‚Œã§ååˆ†ã¨ã„ã†ã®ã§ã‚ã‚Œã°ã€ãœã²ã“ã¡ã‚‰ã®æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚

## è¨­å®šæ–¹æ³•
ä»¥ä¸‹ã¯tiup playgroundã‚’åˆ©ç”¨ã—ãŸä¾‹ã§ã€v8.0ä»¥é™ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãªã©ã¯TiDB Self-Managedã§ã‚‚åŒæ§˜ã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

https://docs.pingcap.com/tidb/stable/system-variables#tidb_general_log ã«å¾“ã£ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
- `log.level`ã‚’`info`ã¾ãŸã¯`debug`ã¨ã—ã¾ã™ã€‚
- `log.general-log-file`ã¾ãŸã¯`log.file.filename`ã«å‡ºåŠ›ã—ãŸã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦è¨˜è¿°ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åãªã©ã¯é©å®œè¨­å®šãã ã•ã„ã€‚
```toml
[log]
# Log level: debug, info, warn, error, fatal.
level = "info"

# Stores general log into separated files.
# If it equals to empty, the general log will be written to the server log.
general-log-file = "tidb-general-log.log"
```

ä¸Šè¨˜ã®å†…å®¹ã‚’`tidb.toml`ã¨ã—ã¦ä¿å­˜ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«tiup playgroundã‚’èµ·å‹•ã—ã¾ã™ã€‚
```shell
tiup playground v8.1.1 --db 1 --db.config tidb.toml
```

playgroundã‚¯ãƒ©ã‚¹ã‚¿ãŒèµ·å‹•ã—ãŸã‚‰ã€TiDBã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦general logã®å‡ºåŠ›ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚
```sql
tidb:4000 > SHOW VARIABLES LIKE 'tidb_general_log';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| tidb_general_log | OFF   |
+------------------+-------+
1 row in set (0.01 sec)

tidb:4000 > SET GLOBAL tidb_general_log='ON';
Query OK, 0 rows affected (0.00 sec)

tidb:4000 > SHOW VARIABLES LIKE 'tidb_general_log';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| tidb_general_log | ON    |
+------------------+-------+
1 row in set (0.01 sec)
```

ã„ãã¤ã‹ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã€ãã®å¾Œã€ãƒ­ã‚°ã®å‡ºåŠ›ã‚’ç¢ºèªã—ã¾ã™ã€‚playgroundã‚¯ãƒ©ã‚¹ã‚¿ã¾ãŸã¯TiDB Self-Managedã®å ´åˆã€ãƒ­ã‚°ã®å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ãŒï¼’ã¤ã‚ã‚Šã¾ã™ã€‚
1. ç®¡ç†ç”»é¢ã§ç¢ºèªã™ã‚‹
2. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¢ºèªã™ã‚‹

### ç®¡ç†ç”»é¢ã§ç¢ºèªã™ã‚‹
playgroundã®å ´åˆã€é€šå¸¸ã¯ http://127.0.0.1:2379/dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ç®¡ç†ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®ç®¡ç†ç”»é¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã€å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®"Search Logs"ï¼ˆè™«çœ¼é¡ãŒæ›¸ã‹ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ãã®å¾Œã€æ¤œç´¢ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã« `\[GENERAL_LOG\]`ï¼ˆæ­£è¦è¡¨ç¾ã¨ã—ã¦æ‰±ã‚ã‚Œãªã„ã‚ˆã†ã«æ‹¬å¼§ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã„ã¾ã™ï¼‰ã¨å…¥åŠ›ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ãŸã‚¯ã‚¨ãƒªãŒãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](/images/20241015172156.png)

### ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¢ºèªã™ã‚‹
ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å‚ç…§ã—ãŸã„å ´åˆã€ãƒ­ã‚°ã®å‡ºåŠ›å…ˆã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†ç”»é¢ã®ãƒ­ã‚°æ¤œç´¢ç”»é¢ã§`filename`ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã—ã¦æ¤œç´¢ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒ`/Users/shige/.tiup/data/URG0lYF`ã§ã‚ã‚‹ã“ã¨ãŒç‰¹å®šã§ãã¾ã™ã€‚ ã‚‚ã—ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã›ãšã«ç¢ºèªã—ãŸã„å ´åˆã¯`${HOME}/.tiup/data`ç›´ä¸‹ã«ã‚ã‚‹æœ€æ–°ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‚ç…§ã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
![](/images/20241015172850.png)

`${HOME}/.tiup/data`ä»¥ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã«ã¯`--tag`ã§æŒ‡å®šã—ãŸå€¤ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚ã‚ˆã£ã¦ã€ã‚ã‹ã‚Šã‚„ã™ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã«ã—ãŸã„å ´åˆã¯playgroundèµ·å‹•æ™‚ã«`--tag`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
```shell
# tagã‚’æŒ‡å®šã—ã¦Playgroundã‚’èµ·å‹•ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®ä¾‹
tiup playground v8.1.1 --db 1 --db.config tidb.toml --tag general-log
```

general logã¯TiDBã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã”ã¨ã«å‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€ä»Šå›ã®ã‚ˆã†ã«TiDBãƒãƒ¼ãƒ‰ãŒï¼‘ã¤ã—ã‹ãªã„å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«`${HOME}/.tiup/data/${tag}/tidb-0`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
```shell
$ ls -l ~/.tiup/data/URG0lYF/tidb-0
total 336
drwxr-x--- 2 shige staff     64 10 15 17:33 oom_record
-rw------- 1 shige staff    884 10 15 17:36 tidb-general-log.log
-rw------- 1 shige staff    649 10 15 17:33 tidb-slow.log
-rw-r--r-- 1 shige staff 275045 10 15 17:36 tidb.log
-rw-r--r-- 1 shige staff     91 10 15 17:33 tidb.toml
```

å‡ºåŠ›å†…å®¹ã¯å½“ç„¶ã§ã™ãŒç®¡ç†ç”»é¢ä¸Šã§è¦‹ã‚Œã‚‹ã‚‚ã®ã¨åŒã˜ã§ã™ã€‚
```
[2024/10/15 17:02:37.241 +09:00] [INFO] [session.go:3920] [GENERAL_LOG] [conn=482344968] [session_alias=] [user=root@127.0.0.1] [schemaVersion=51] [txnStartTS=0] [forUpdateTS=0] [isReadConsistency=false] [currentDB=test] [isPessimistic=false] [sessionTxnMode=PESSIMISTIC] [sql="SHOW VARIABLES LIKE 'tidb_general_log'"]
[2024/10/15 17:05:33.626 +09:00] [INFO] [session.go:3920] [GENERAL_LOG] [conn=482344968] [session_alias=] [user=root@127.0.0.1] [schemaVersion=51] [txnStartTS=0] [forUpdateTS=0] [isReadConsistency=false] [currentDB=test] [isPessimistic=false] [sessionTxnMode=PESSIMISTIC] [sql="SELECT DATABASE()"]
[2024/10/15 17:05:33.627 +09:00] [INFO] [session.go:3920] [GENERAL_LOG] [conn=482344968] [session_alias=] [user=root@127.0.0.1] [schemaVersion=51] [txnStartTS=0] [forUpdateTS=0] [isReadConsistency=false] [currentDB=test] [isPessimistic=false] [sessionTxnMode=PESSIMISTIC] [sql="use `testl`"]
[2024/10/15 17:05:36.099 +09:00] [INFO] [session.go:3920] [GENERAL_LOG] [conn=482344968] [session_alias=] [user=root@127.0.0.1] [schemaVersion=51] [txnStartTS=0] [forUpdateTS=0] [isReadConsistency=false] [currentDB=test] [isPessimistic=false] [sessionTxnMode=PESSIMISTIC] [sql="SELECT DATABASE()"]
[2024/10/15 17:05:36.100 +09:00] [INFO] [session.go:3920] [GENERAL_LOG] [conn=482344968] [session_alias=] [user=root@127.0.0.1] [schemaVersion=51] [txnStartTS=0] [forUpdateTS=0] [isReadConsistency=false] [currentDB=test] [isPessimistic=false] [sessionTxnMode=PESSIMISTIC] [sql="use `test`"]
```

# ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ã£ã¦ã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹
ã‚¯ã‚¨ãƒªã®ãƒ­ã‚®ãƒ³ã‚°ã‚’ã—ãŸã„ã‚¯ãƒ©ã‚¹ã‚¿ãŒTiDB Cloudã«ã‚ã‚‹ãªã©ã€ä½•ã‚‰ã‹ã®ç†ç”±ã§general logã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ããªã„å ´åˆã€ã‚¯ãƒ©ã‚¹ã‚¿ã®æ‰‹å‰ã«ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’ç½®ã„ã¦ã€ãã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã«ã‚¯ã‚¨ãƒªã‚’ãƒ­ã‚°å‡ºåŠ›ã•ã›ã‚‹ã¨ã„ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ã“ã“ã§ã¯ã€ãã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’ç°¡æ˜“ã«å®Ÿè£…ã—ã¦è¦‹ãŸã„ã¨æ€ã„ã¾ã™ã€‚

:::message
åŒæ§˜ã®ã“ã¨ã¯ä»–ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ç”¨ã„ã¦ã‚‚å®Ÿç¾å¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ã€[ProxySQL](https://proxysql.com/)ã¯Query Loggingã¨ã„ã†æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
- https://proxysql.com/documentation/query-logging/
:::

:::message alert
ã“ã‚Œä»¥é™ã®è¨˜äº‹ã§ã¯å®Œå…¨ãªãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚ãã¾ã§ç°¡æ˜“çš„ãªã‚‚ã®ã§ã‚ã‚Šã€å®Ÿç”¨ã«è€ãˆã‚‹ã‚‚ã®ã§ã¯ãªã„ã“ã¨ã«ç•™æ„ã—ã¦èª­ã¿é€²ã‚ã¦ãã ã•ã„ã€‚
:::

ã•ã¦ã€æ—©é€Ÿå§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã“ã“ã§ã¯Goã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¾ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«[go-mysql](https://github.com/go-mysql-org/go-mysql)ã‚’ç”¨ã„ã‚‹ã®ã§ã€ã‚ã‚‰ã‹ã˜ã‚`go get`ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã«ã‚³ãƒãƒ³ãƒ‰ã®ä¾‹ã‚’è¨˜è¼‰ã—ã¾ã™ãŒã€ã”è‡ªèº«ã®ç’°å¢ƒã«åˆã‚ã›ã¦é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```shell
$ go mod init example-proxy/m
go: creating new go.mod: module example-proxy/m

$ go mod vendor
go: warning: "all" matched no packages
go: no dependencies to vendor

$ go get "github.com/go-mysql-org/go-mysql"

$ touch main.go

$ \ls -l
total 8
-rw-r--r-- 1 shige wheel  95 10 17 11:07 go.mod
-rw-r--r-- 1 shige wheel 183 10 17 11:07 go.sum
-rw-r--r-- 1 shige wheel   0 10 17 11:08 main.go
drwxr-xr-x 3 shige wheel  96 10 17 11:07 vendor
```

æº–å‚™ãŒæ•´ã£ãŸã‚‰æ—©é€Ÿå®Ÿè£…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã¨ã¯ã„ãˆã€ã“ã“ã§ã¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¨ã¯ä½•ãã‚„ã¨ã„ã†ã“ã¨ã«ã¯è§¦ã‚Œãšã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒšã™ã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚[Readmeã«ã‹ã‹ã‚Œã¦ã„ã‚‹Exampleã®ã‚³ãƒ¼ãƒ‰](https://github.com/go-mysql-org/go-mysql?tab=readme-ov-file#example-2)ã‚’`main.go`ã«ã‚³ãƒ”ãƒšã—ã¾ã—ã‚‡ã†ã€‚1ã¤ã ã‘ä¿®æ­£ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ4000ç•ªã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã¾ã™ãŒã€ã“ã®ã‚ã¨ã«èµ·å‹•ã™ã‚‹playgroundã‚¯ãƒ©ã‚¹ã‚¿ã‚‚4000ç•ªã‚’ä½¿ã†ãŸã‚ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®ã»ã†ã¯4000ç•ªä»¥å¤–ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
```go
	// ãƒãƒ¼ãƒˆ4001ç•ªã‚’ãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
	l, err := net.Listen("tcp", "127.0.0.1:4001")
```

ä¿®æ­£ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ã¾ã™ã€‚
```shell
$ go mod tidy

$ go mod vendor

$ go run main.go
```

æ¬¡ã«ã€æ–°ã—ã„ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’èµ·å‹•ã—ã€tiup playgroundã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚
```shell
$ tiup playground v8.1.1 --db 1 --tiflash 0 --without-monitor
```

ã‚‚ã†1åº¦æ–°ã—ã„ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’èµ·å‹•ã—ã€ç«‹ã¡ä¸Šã’ãŸãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã™ã€‚ãƒãƒ¼ãƒˆç•ªå·ã¯å…ˆã»ã©ä¿®æ­£ã—ãŸç•ªå·ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
```shell
mysql --comments --host 127.0.0.1 --port 4001 -u root
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 10001
Server version: 5.7.0

Copyright (c) 2000, 2024, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>
```

ã¤ãªãŒã‚Šã¾ã—ãŸï¼å˜ç´”ãªã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€ã“ã®ã‚ˆã†ã«æ¥ç¶šã§ããŸã“ã¨ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚Œã¦ããŸMySQLãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä¸Šæ‰‹ããƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã§ã™ãŒã€æœ¬æ¥ã®æ¥ç¶šå…ˆã§ã‚ã‚‹playgroundã¨ã¯æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãªã®ã§ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚
```sql
mysql> show databases;
ERROR 1105 (HY000): not supported now
mysql>
```

`not supported now`ã¨ã§ã¦ã„ã¾ã™ã­ã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆ`server.EmptyHandler`ï¼‰ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

## ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…
ã“ã“ã‹ã‚‰ã™ã“ã—ã‚³ãƒ¼ãƒ‰ã«è¶³ã‚’è¸ã¿å…¥ã‚Œã¦ã¿ã¾ã—ã‚‡ã†ã€‚`server.EmptyHandler`ã¯interfaceã§ã‚ã‚‹`server.Handler`ã‚’å®Ÿè£…ã—ãŸã‚‚ã®ã§ã™ã€‚`server.Handler`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/go-mysql-org/go-mysql/blob/v1.9.1/server/command.go#L12-L32

ãªã®ã§ã€ç‹¬è‡ªã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®šç¾©ã—ã¦ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã‚’å®Ÿè£…ã™ã‚Œã°ã‚ˆã„ã‚ã‘ã§ã™ã­ã€‚ã¾ãŸã€ã“ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¯å½“ç„¶TiDBã«æ¥ç¶šã—ã¦ã€ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä»£ã‚ã£ã¦é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§ã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰DBã‚µãƒ¼ãƒãƒ¼ã€ã“ã“ã§ã¯TiDBã‚¯ãƒ©ã‚¹ã‚¿ã¸æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã‚ˆã£ã¦ã€ä»Šå›ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¯1) `server.Handler`ã®å®Ÿè£…ã€2) DBã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã€3) ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ä¿¡ã•ã‚Œã¦ããŸã‚³ãƒãƒ³ãƒ‰ã®ãƒ­ã‚°å‡ºåŠ›ã€ä»¥ä¸Š3ã¤ã‚’å®Ÿç¾ã™ã‚Œã°è‰¯ã„ã‚ã‘ã§ã™ã€‚ç°¡å˜ã§ã™ã­ï¼

## ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…
æ—©é€Ÿãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…ã«å…¥ã‚Šã¾ã—ã‚‡ã†ã€‚å…ˆã»ã©ãŠä¼ãˆã—ãŸã‚ˆã†ã«ã€`server.Handler`ã‚’å®Ÿè£…ã™ã‚‹ã ã‘ãªã®ã§ã€[å¿…è¦ãªéƒ¨åˆ†](https://github.com/go-mysql-org/go-mysql/blob/v1.9.1/server/command.go#L12-L32)ã‚’ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚ãã®å¾Œã€è‡ªåˆ†ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®šç¾©ã—ã¦ã€ãã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’`server.NewConn`ã«æ¸¡ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```go
package main

import (
	"fmt"
	"log"
	"net"

	. "github.com/go-mysql-org/go-mysql/mysql"
	"github.com/go-mysql-org/go-mysql/server"
)

type handler struct{}

func (h handler) UseDB(dbName string) error {
	return nil
}
func (h handler) HandleQuery(query string) (*Result, error) {
	return nil, fmt.Errorf("not supported now")
}

func (h handler) HandleFieldList(table string, fieldWildcard string) ([]*Field, error) {
	return nil, fmt.Errorf("not supported now")
}
func (h handler) HandleStmtPrepare(query string) (int, int, interface{}, error) {
	return 0, 0, nil, fmt.Errorf("not supported now")
}
func (h handler) HandleStmtExecute(context interface{}, query string, args []interface{}) (*Result, error) {
	return nil, fmt.Errorf("not supported now")
}

func (h handler) HandleStmtClose(context interface{}) error {
	return nil
}

func (h handler) HandleOtherCommand(cmd byte, data []byte) error {
	return NewError(
		ER_UNKNOWN_ERROR,
		fmt.Sprintf("command %d is not supported now", cmd),
	)
}

func main() {
	l, err := net.Listen("tcp", "127.0.0.1:4001")
	if err != nil {
		log.Fatal(err)
	}

	for {
		c, err := l.Accept()
		if err != nil {
			log.Fatal(err)
		}

		conn, err := server.NewConn(c, "root", "", handler{})
		if err != nil {
			log.Fatal(err)
		}

		// as long as the client keeps sending commands, keep handling them
		for {
			if err := conn.HandleCommand(); err != nil {
				log.Fatal(err)
			}
		}
	}
}
```

ã“ã‚Œã§ç‹¬è‡ªã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒç”¨æ„ã§ãã¾ã—ãŸã€‚ã¾ãŸã€`l.Accept`ã‹ã‚‰`conn.HandleCommand`ã‚’`for` ãƒ«ãƒ¼ãƒ—ã§å›²ã†ã“ã¨ã§ã€ç¶™ç¶šçš„ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶šã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã®æ®µéšã§ã¯ã€æœ€åˆã«ã‚³ãƒ”ãƒšã—ãŸã‚³ãƒ¼ãƒ‰ã¨ã»ã¨ã‚“ã©å¤‰ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã®ã‚ã¨ã®DBã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã¸ã®å®Ÿè£…ã‚’é€šã˜ã¦ã•ã‚‰ã«è‚‰ä»˜ã‘ã—ã¦ã„ãã¾ã™ã€‚

## DBã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶š
DBã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã‚’å®Ÿè£…ã—ã¾ã™ã€‚å®Ÿè£…ã‚’å˜ç´”ã«ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹é‡ã§å®Ÿè£…ã—ã¾ã™ã€‚
1. å¿…è¦ãªæ¥ç¶šå…ˆã®æƒ…å ±ã¯ã™ã¹ã¦ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™
2. æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã¯ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«è¡Œã†

`go-mysql`ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚æä¾›ã—ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã„ã¾ã™ã€‚ä»¥ä¸‹ã§ã¯ä¸»ãªå¤‰æ›´éƒ¨åˆ†ã§ã‚ã‚‹`import`ã¨`main`é–¢æ•°ã€æ–°è¦ã«è¿½åŠ ã—ãŸ`run`é–¢æ•°ã‚’æŠœãå‡ºã—ã¦ã„ã¾ã™ã€‚

```go
package main

import (
	...
	"github.com/go-mysql-org/go-mysql/client"
	...
)

...

func main() {
	targetAddress := os.Getenv("MYPROXY_TARGET")
	if targetAddress == "" {
		log.Printf("WARN: target address to be forwarded is missing. Set default address: %s", defaultTargetAddress)
		targetAddress = defaultTargetAddress
	}
	dbUser := os.Getenv("MYPROXY_DB_USER")
	if dbUser == "" {
		log.Printf("WARN: DB user is not set. Set default DB user: %s", defaultDBUser)
		dbUser = defaultDBUser
	}

	dbPassword := os.Getenv("MYPROXY_DB_PASSWORD")
	if dbPassword == "" {
		log.Print("WARN: DB password is not set. Set default DB password")
		dbPassword = defaultDBPassword
	}

	l, err := net.Listen("tcp", "127.0.0.1:4001")
	if err != nil {
		log.Fatal(err)
	}
	defer l.Close()

	for {
		c, err := l.Accept()
		if err != nil {
			log.Fatal(err)
		}

		go run(c, targetAddress, dbUser, dbPassword)
	}
}

func run(c net.Conn, targetAddress, dbUser, dbPassword string) {
	clientConn, err := client.Connect(targetAddress, dbUser, dbPassword, "test")
	if err != nil {
		log.Fatalf("Fatal: failed to establish the connection to the database server (%s, %s): %v", targetAddress, dbUser, err)
	}
	if err := clientConn.Ping(); err != nil {
		log.Fatalf("Fatal: failed to receive ping response from %s: %v", targetAddress, err)
	}
	defer clientConn.Close()

	h := handler{clientConn}
	serverConn, err := server.NewConn(c, "root", "", h)
	if err != nil {
		log.Fatal(err)
	}
	defer serverConn.Close()

	for {
		if err := serverConn.HandleCommand(); err != nil {
			log.Printf("WARN: failed to handle command: %v", err)
		}
	}
}
```
ã‚„ã‚„é•·ã„ã§ã™ãŒã€ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚acceptã—ãŸæ¥ç¶šã‚’`run`ã«æ¸¡ã—ã¦ã€æ¥ç¶šã”ã¨ã«ç‹¬ç«‹ã—ãŸå‡¦ç†ã¨ãªã‚‹ã‚ˆã†ã«go routineã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã«å‡¦ç†ã‚’åˆ†ã‘ã¦ã„ã¾ã™ã€‚ã¾ãŸã€`serverConn.HandleCommand()`ã‹ã‚‰å—ã‘å–ã£ãŸã‚¨ãƒ©ãƒ¼ã‚’`log.Fatal`ã‹ã‚‰`log.Printf`ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ãŒãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’æ­¢ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã§ã™ã€‚

`run`é–¢æ•°ã§ã¯ä»¥ä¸‹ã‚’ã—ã¦ã„ã¾ã™ã€‚
1. ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¨DBã‚µãƒ¼ãƒãƒ¼é–“ã§ã®æ¥ç¶šï¼ˆ`client.Connect`ï¼‰
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼é–“ã§ã®æ¥ç¶šï¼ˆ`server.NewConn`ï¼‰
	- DBã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«æ¸¡ã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸã‚³ãƒãƒ³ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ï¼ˆ`serverConn.HandleCommand`ï¼‰

ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ï¼ç‰¹ã«ç”³ã—ä¸Šã’ã‚‹ã“ã¨ã¯ç„¡ã„ã‹ã¨æ€ã„ã¾ã™ã€‚ã§ã‚‚ã€ã“ã‚Œã§ä»Šå›å®Ÿè£…ã—ãŸã„äº‹æŸ„ã®ï¼™å‰²ã¯å®Ÿè£…ã§ãã¾ã—ãŸã€‚ã§ã¯æ®‹ã‚Šã‚’å®Ÿè£…ã—ã¾ã—ã‚‡ã†ï¼ã¤ãã‚‚ç°¡å˜ã§ã™ã‚ˆï¼

## ã‚³ãƒãƒ³ãƒ‰ã®ãƒ­ã‚°å‡ºåŠ›ãŠã‚ˆã³è»¢é€ã‚’å®Ÿè£…ã™ã‚‹
ã‚ˆã†ã‚„ãä»Šå›ã®ç›®çš„ã§ã‚ã‚‹ã‚³ãƒãƒ³ãƒ‰ã®ãƒ­ã‚°å‡ºåŠ›ã¾ã§ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚ã¨ã“ã‚ã§ã€ãƒ­ã‚°ã«å‡ºåŠ›ã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ã€ã¤ã¾ã‚Šã‚¯ã‚¨ãƒªã¯ã©ã†ã‚„ã£ã¦å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã“ã“ã§æ”¹ã‚ã¦ã‚³ãƒ”ãƒšã—ãŸãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®é–¢æ•°ã®ï¼‘ã¤ã§ã‚ã‚‹`HandleQuery`ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```go
func (h handler) HandleQuery(query string) (*Result, error) {
	return nil, fmt.Errorf("not supported now")
}
```

å¼•æ•°ã«`query`ãŒã‚ã‚Šã¾ã™ã­ï¼ã©ã†ã‚„ã‚‰`HandleQuery`ã¯ã‚¯ã‚¨ãƒªã‚’å—ã‘å–ã‚‹ã‚ˆã†ã§ã™ã€‚ã¾ãŸã€è¿”ã‚Šå€¤ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’è¦‹ã‚‹ã¨`*Result`ã¨ã‚ã‚‹ã®ã§ã€`HandleQuery`ã¯ã‚¯ã‚¨ãƒªã‚’å—ã‘å–ã‚‹ã ã‘ã§ãªãã€ã‚¯ã‚¨ãƒªã‚’å—ã‘å–ã‚Šã€å®Ÿè¡Œã—ã¦ã€ãã®çµæœã‚»ãƒƒãƒˆã‚’è¿”å´ã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚’å—ã‘æŒã¤ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã§ã¯ã€ã©ã†ã‚„ã£ã¦ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã‚„ã‚ŠãŸã„ã“ã¨ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å—ã‘å–ã£ãŸã‚¯ã‚¨ãƒªã‚’DBã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ãŸã„ã‚ã‘ã§ã™ã­ã€‚ã¨ã„ã†ã“ã¨ã¯ã€DBã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ©ç”¨ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ããã†ã§ã™ã€‚å®Ÿéš›ã«[ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰](https://github.com/go-mysql-org/go-mysql/tree/v1.9.1?tab=readme-ov-file#client)ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`Execute`ã‚’ä½¿ã†ã“ã¨ã§ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã§ããã†ãªã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã“ã“ã§ã¯å®Ÿè£…ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã€`UseDB`ã€`HandleQuery`ã®ï¼’ã¤ã®ã¿ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ä½™åŠ›ãŒã‚ã‚‹èª­è€…ã¯ãã®ä»–ã®é–¢æ•°ã‚‚å®Ÿè£…ã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚
```go
...
func (h handler) UseDB(dbName string) error {
	log.Printf("ID: %d, DB: %s", h.clientConn.GetConnectionID(), dbName)
	return h.clientConn.UseDB(dbName)
}
func (h handler) HandleQuery(query string) (*Result, error) {
	log.Printf("ID: %d, DB: %s, QUERY: %s", h.clientConn.GetConnectionID(), h.clientConn.GetDB(), query)
	return h.clientConn.Execute(query)
}
...
```

å˜ç´”ã§ã™ã­ï¼ã“ã‚Œã‚‚è¦‹ãŸãã®ã¾ã¾ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ãƒ­ã‚°ã®å‡ºåŠ›ã«ã¯ã€æ¥ç¶šã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã®IDã€æ¥ç¶šå…ˆDBåã€ãã—ã¦ã‚¯ã‚¨ãƒªãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

æœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®gistã§ã”ç¢ºèªãã ã•ã„ã€‚
https://gist.github.com/sgykfjsm/07b7b44a66e2f42f1e0cf96b6f9974e8

ãŠãŠã‚ˆã110è¡Œå¼·ã§å®Ÿè£…ã§ãã¾ã—ãŸã€‚å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ­ã‚°ãŒå–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚é€”ä¸­ã§IDãŒä»£ã‚ã£ã¦ã„ã‚‹ã®ã¯æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šãŒå…¥ã£ã¦ããŸãŸã‚ã§ã™ã€‚
```
$ go run main.go
2024/10/21 17:48:18 WARN: target address to be forwarded is missing. Set default address: 127.0.0.1:4000
2024/10/21 17:48:18 WARN: DB user is not set. Set default DB user: root
2024/10/21 17:48:18 WARN: DB password is not set. Set default DB password
2024/10/21 17:48:19 ID: 2514485272, USE DB: test
2024/10/21 17:48:19 ID: 2514485272, DB: test, QUERY: show databases
2024/10/21 17:48:19 ID: 2514485272, DB: test, QUERY: show tables
2024/10/21 17:48:19 ID: 2514485272, DB: test, QUERY: SELECT * FROM `t` LIMIT 0
2024/10/21 17:48:19 ID: 2514485272, DB: test, QUERY: select @@version_comment limit 1
2024/10/21 17:48:20 ID: 2514485272, DB: test, QUERY: select $$
2024/10/21 17:48:24 ID: 2514485272, DB: test, QUERY: show databases
2024/10/21 17:48:34 ID: 2514485272, DB: test, QUERY: SELECT DATABASE()
2024/10/21 17:48:34 ID: 2514485272, USE DB: test
2024/10/21 17:48:36 ID: 2514485272, DB: test, QUERY: show tables
2024/10/21 17:48:57 ID: 2514485272, DB: test, QUERY: create table t1 (id bigint primary key auto_increment)
2024/10/21 17:49:11 ID: 2514485272, DB: test, QUERY: insert into t1 values (1), (2), (3)
2024/10/21 17:49:20 ID: 2514485272, DB: test, QUERY: select * from t1
2024/10/21 17:49:43 ID: 2514485272, DB: test, QUERY: update t1 set id = id + 10
2024/10/21 17:49:50 ID: 2514485272, DB: test, QUERY: select * from t1
2024/10/21 17:49:57 ID: 2514485272, DB: test, QUERY: delete from t1
2024/10/21 17:49:59 ID: 2514485272, DB: test, QUERY: select * from t1
2024/10/21 17:50:02 ID: 2514485274, USE DB: test
2024/10/21 17:50:02 ID: 2514485274, DB: test, QUERY: show databases
2024/10/21 17:50:02 ID: 2514485274, DB: test, QUERY: show tables
2024/10/21 17:50:02 ID: 2514485274, DB: test, QUERY: SELECT * FROM `t` LIMIT 0
2024/10/21 17:50:02 ID: 2514485274, DB: test, QUERY: SELECT * FROM `t1` LIMIT 0
2024/10/21 17:50:02 ID: 2514485274, DB: test, QUERY: select @@version_comment limit 1
2024/10/21 17:50:02 ID: 2514485274, DB: test, QUERY: select $$
```

# ã¾ã¨ã‚
ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿã“ã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã‚’ã”ç´¹ä»‹ã—ã¾ã—ãŸã€‚
1. TiDBã§general logã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•
2. ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’ç”¨ã„ã¦ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•

å†…å®¹ã®æ®†ã©ãŒãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€ã“ã‚Œã¯ä½œè€…ã®è¶£å‘³ã§ã™ã€‚general logãªã©ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªã®ãƒ­ã‚°å‡ºåŠ›ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ´»ç”¨ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ã¯æ¬ ã‹ã›ãªã„ã¨æ€ã„ã¾ã™ã®ã§ã€ã“ã“ã§ç´¹ä»‹ã—ãŸå†…å®¹ã‚’ãœã²æ—¥ã€…ã®é–‹ç™ºã«ãŠå½¹ç«‹ã¦ãã ã•ã„ã€‚


æœ€å¾Œã«ï¼ˆãã—ã¦ç¹°ã‚Šè¿”ã—ã«ï¼‰ãªã‚Šã¾ã™ãŒã€ä»Šå›ã”ç´¹ä»‹ã—ãŸãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…ã¯ç°¡æ˜“ãªã®ã‚‚ã®ã§å®Ÿç”¨ã«ã¯è€ãˆã¾ã›ã‚“ã€‚ä¾‹ãˆã°ãƒ—ãƒªãƒšã‚¢ãƒ¼ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã«å¯¾å¿œã—ã¦ãŠã‚Šã¾ã›ã‚“ã—ã€è¤‡æ–‡ï¼ˆ`select 1; select version();`ã®ã‚ˆã†ã«ï¼‘ã¤ã®ã‚³ãƒ¼ãƒ«ã«è¤‡æ•°ã®ã‚¯ã‚¨ãƒªãŒå«ã¾ã‚Œã‚‹ã“ã¨ï¼‰ã«ã¯å¯¾å¿œã—ã¦ãŠã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã‚‚é›†ä¸­çš„ãªæ¥ç¶šã«è€ãˆã‚Œã‚‹ã‚ˆã†ãªå®Ÿè£…ã«ã¯ãªã£ã¦ã„ãªã„ç‚¹ã‚‚æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ã”è‡ªèº«ã§ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹éš›ã®å‚è€ƒã¨ã—ã¦ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚